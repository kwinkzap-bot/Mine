{% extends 'base.html' %}

{% block title %}Historical Data{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/historical.css') }}">
{% endblock %}

{% block content %}
<div class="historical-container">
    <h1>Historical Data Viewer</h1>
    
    <form id="historicalForm">
        <!-- Instrument Type Selection -->
        <div class="form-row">
            <div class="form-group">
                <label for="instrumentType">Instrument Type:</label>
                <select id="instrumentType">
                    <option value="fno">F&O</option>
                    <option value="indices">Indices</option>
                </select>
            </div>
            <div class="form-group">
                <label for="symbolSelect">Symbol:</label>
                <select id="symbolSelect">
                    <option value="">Select symbol</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fnoType">F&O Type:</label>
                <select id="fnoType">
                    <option value="futures">Futures</option>
                    <option value="options">Options</option>
                </select>
            </div>
        </div>

        <!-- Option Fields (Expiry & Strike) - Hidden by default -->
        <div class="form-row" id="optionFields" style="display: none;">
            <div class="form-group">
                <label for="expiryDate">Expiry Date:</label>
                <select id="expiryDate">
                    <option value="">Select expiry</option>
                </select>
            </div>
            <div class="form-group">
                <label for="strikePrice">Strike Price:</label>
                <select id="strikePrice">
                    <option value="">Select strike</option>
                </select>
            </div>
        </div>

        <!-- Date Range & Interval -->
        <div class="form-row">
            <div class="form-group">
                <label for="fromDate">From Date:</label>
                <input type="date" id="fromDate">
            </div>
            <div class="form-group">
                <label for="toDate">To Date:</label>
                <input type="date" id="toDate">
            </div>
            <div class="form-group">
                <label for="interval">Interval:</label>
                <select id="interval">
                    <option value="minute">1 Minute</option>
                    <option value="3minute">3 Minutes</option>
                    <option value="5minute" selected>5 Minutes</option>
                    <option value="15minute">15 Minutes</option>
                    <option value="30minute">30 Minutes</option>
                    <option value="60minute">1 Hour</option>
                    <option value="day">Daily</option>
                    <option value="week">Weekly</option>
                    <option value="month">Monthly</option>
                </select>
            </div>
        </div>

        <!-- Manual Token Mode -->
        <div class="form-row" id="manualTokenContainer" style="display: none;">
            <div class="form-group">
                <label for="manualTokenInput">Instrument Token:</label>
                <input type="text" id="manualTokenInput" placeholder="Enter instrument token">
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-row">
            <div class="form-group">
                <button type="button" id="manual-token-btn" class="btn form-button">Toggle Manual Token</button>
            </div>
            <div class="form-group">
                <button type="submit" class="btn form-button">Fetch Data</button>
            </div>
        </div>
    </form>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden results-section">
        <h2>Historical Data</h2>
        <div id="statusMessage" class="status-message hidden"></div>
        <div id="statsContainer" class="stats-container hidden"></div>
        <canvas id="historicalChart"></canvas>
        
        <div class="data-table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th class="numeric">Open</th>
                        <th class="numeric">High</th>
                        <th class="numeric">Low</th>
                        <th class="numeric">Close</th>
                        <th class="numeric">Volume</th>
                        <th class="numeric">OI</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>

        <div id="noDataMessage" class="no-data hidden">
            <div class="no-data-icon">ðŸ“­</div>
            <div class="no-data-text">No data available for the selected criteria</div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <!-- Ensure constants.js is loaded first -->
    <script src="{{ url_for('static', filename='js/constants.js') }}"></script>
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@latest/dist/lightweight-charts.standalone.production.js"></script>
    <script src="{{ url_for('static', filename='js/historical.js') }}"></script>
{% endblock %}